name: Destroy Flask Game Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Manual confirmation
        run: |
          echo "ğŸš¨ DESTRUCTION CONFIRMATION REQUIRED ğŸš¨"
          echo "This will DESTROY all infrastructure including:"
          echo "â€¢ ECS Cluster & Service"
          echo "â€¢ RDS Database (ALL DATA WILL BE LOST)"
          echo "â€¢ ALB & Target Groups"
          echo "â€¢ VPC & Networking components"
          echo "â€¢ ECR Repository (including all images)"
          echo ""
          echo "Type 'DESTROY' to continue or press Ctrl+C to cancel:"
          read user_input
          if [ "$user_input" != "DESTROY" ]; then
            echo "âŒ Destruction cancelled"
            exit 1
          fi

      - name: Stop ECS tasks and services
        run: |
          # åœæ­¢ ECS æœåŠ¡
          aws ecs update-service \
            --cluster flask-game-cluster \
            --service flask-game-service \
            --desired-count 0 \
            --region $AWS_REGION || echo "ECS service might not exist"
          
          sleep 30
          
          # åˆ é™¤ ECS æœåŠ¡
          aws ecs delete-service \
            --cluster flask-game-cluster \
            --service flask-game-service \
            --force \
            --region $AWS_REGION || echo "ECS service might not exist"

      - name: Force delete ECR repository
        run: |
          # å¼ºåˆ¶åˆ é™¤ ECR ä»“åº“åŠå…¶æ‰€æœ‰é•œåƒ
          REPO_NAME="flask-game"
          
          # æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
          if aws ecr describe-repositories --repository-names $REPO_NAME --region $AWS_REGION > /dev/null 2>&1; then
            echo "ECR repository exists, force deleting..."
            
            # è·å–æ‰€æœ‰é•œåƒ
            IMAGE_DIGESTS=$(aws ecr list-images --repository-name $REPO_NAME --region $AWS_REGION --query 'imageIds[].imageDigest' --output text)
            
            if [ ! -z "$IMAGE_DIGESTS" ]; then
              echo "Deleting all images from ECR repository..."
              
              # ä¸ºæ¯ä¸ªé•œåƒæ‘˜è¦åˆ›å»ºåˆ é™¤å‘½ä»¤
              DIGEST_ARGS=""
              for digest in $IMAGE_DIGESTS; do
                DIGEST_ARGS="$DIGEST_ARGS imageDigest=$digest"
              done
              
              # æ‰¹é‡åˆ é™¤é•œåƒ
              aws ecr batch-delete-image \
                --repository-name $REPO_NAME \
                --image-ids $DIGEST_ARGS \
                --region $AWS_REGION || echo "Failed to delete some images, continuing..."
            fi
            
            # å¼ºåˆ¶åˆ é™¤ä»“åº“
            aws ecr delete-repository \
              --repository-name $REPO_NAME \
              --force \
              --region $AWS_REGION
            echo "âœ… ECR repository force deleted"
          else
            echo "ECR repository does not exist"
          fi

      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      - name: Terraform Destroy (skip ECR)
        run: |
          # ä½¿ç”¨-targetå‚æ•°è·³è¿‡ECRèµ„æºçš„é”€æ¯ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‰‹åŠ¨åˆ é™¤äº†
          terraform destroy -auto-approve \
            -target=aws_db_instance.main \
            -target=aws_ecs_service.main \
            -target=aws_ecs_cluster.main \
            -target=aws_lb.main \
            -target=aws_vpc.main
        working-directory: terraform
        env:
          TF_VAR_db_username: ${{ secrets.DB_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Complete Terraform Destroy
        run: |
          # ç°åœ¨æ‰§è¡Œå®Œæ•´çš„destroyï¼ŒECRåº”è¯¥å·²ç»ä¸å­˜åœ¨äº†
          terraform destroy -auto-approve
        working-directory: terraform
        env:
          TF_VAR_db_username: ${{ secrets.DB_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Verify destruction
        run: |
          echo "âœ… Infrastructure destruction completed!"
          echo "ğŸ’¾ All AWS resources have been terminated."